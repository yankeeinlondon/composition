# YouTube Embedding Implementation

**Created:** 2025-12-19
**Status:** Reviewed - Ready for Implementation

## Review Summary

**Reviews Completed:** 2025-12-19

**Reviewers:**
- Rust Developer: Approve with Changes
- Feature Tester (Rust): Approve with Changes

**Key Changes from Review:**
1. Updated module structure to match existing codebase (`lib/src/parse/` not `lib/src/parser/`)
2. Added `DarkMatterNode::YouTube` variant to types system
3. Clarified asset deduplication happens at orchestration level, not individual renderers
4. Updated test organization to use `#[cfg(test)]` inline modules instead of separate files
5. Added snapshot testing with `insta` crate for HTML output verification
6. Specified use of `std::sync::LazyLock` for regex compilation consistency
7. Added benchmark tests with criterion for performance verification
8. Clarified error handling to use existing `ParseError` variants instead of new types

**Resolved Concerns:**
- Module structure mismatch → Updated to use `lib/src/parse/darkmatter.rs` pattern
- Missing DarkMatterNode variant → Added to Phase 1 deliverables
- Test organization → Updated to match project conventions (inline tests)
- Error type proliferation → Use existing ParseError variants
- Performance testing → Added criterion benchmarks

## Executive Summary

Implement YouTube video embedding support in the DarkMatter DSL via the `::youtube <ref> [width]` directive. This feature will parse YouTube references (URLs or IDs), generate self-contained HTML with inline CSS/JS, and provide an enhanced UI with maximize/modal functionality.

## Requirements

### Functional Requirements

| ID | Requirement | Priority | Owner |
|----|-------------|----------|-------|
| FR-1 | Parse `::youtube <ref> [width]` directive from markdown | High | Rust Developer |
| FR-2 | Extract video ID from various YouTube URL formats | High | Rust Developer |
| FR-3 | Generate self-contained HTML with iframe embed | High | Rust Developer |
| FR-4 | Support width specification (px, rem, %) with 512px default | Medium | Rust Developer |
| FR-5 | Provide maximize button for modal view | Medium | Rust Developer |
| FR-6 | Implement backdrop blur effect in modal state | Medium | Rust Developer |
| FR-7 | Preserve play/pause state during zoom transitions | Low | Rust Developer |
| FR-8 | Handle escape key and backdrop clicks to minimize | Medium | Rust Developer |

### Non-Functional Requirements

| ID | Requirement | Target | Owner |
|----|-------------|--------|-------|
| NFR-1 | Self-contained output (inline CSS/JS) | All assets inline | Rust Developer |
| NFR-2 | Accessibility support (ARIA labels, keyboard nav) | WCAG 2.1 AA | Rust Developer |
| NFR-3 | Error handling for invalid video IDs | Informative errors | Rust Developer |
| NFR-4 | Asset deduplication (CSS/JS once per document) | Single inclusion | Rust Developer |

## Architecture Overview

The YouTube embedding feature integrates into the existing DarkMatter DSL parsing pipeline:

1. **Parser Extension**: Detect `::youtube` block directive in markdown event stream
2. **Directive Handler**: Extract video ID and width parameters
3. **HTML Renderer**: Generate self-contained HTML with inline CSS/JS
4. **Asset Manager**: Deduplicate CSS/JS across multiple embeds in same document

### Component Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    Markdown Input                            │
│                 ::youtube <ref> [width]                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              pulldown-cmark Event Stream                     │
│             (lib/src/parse/markdown.rs)                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│      DarkMatter Directive Parser (lib/src/parse/)            │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  darkmatter.rs (UPDATE)                              │   │
│  │  - YOUTUBE_DIRECTIVE: LazyLock<Regex>                │   │
│  │  - parse_directive() -> DarkMatterNode::YouTube      │   │
│  │  - extract_youtube_id(ref: &str) -> Result<String>   │   │
│  │  - parse_width_spec(width: &str) -> Result<...>      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  types/darkmatter.rs (UPDATE)                        │   │
│  │  - DarkMatterNode::YouTube { video_id, width }       │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  types/youtube.rs (NEW)                              │   │
│  │  - WidthSpec enum (Pixels, Rems, Percentage)         │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        HTML Renderer (lib/src/render/)                       │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  youtube.rs (NEW)                                    │   │
│  │  - render_youtube_embed(video_id, width) -> String   │   │
│  │  - generate_container_html(id, width) -> String      │   │
│  │  - YOUTUBE_CSS: LazyLock<String> (inline styles)     │   │
│  │  - YOUTUBE_JS: LazyLock<String> (inline scripts)     │   │
│  │  - width_to_css(width: &WidthSpec) -> String         │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│         Orchestration Layer (lib/src/render/html.rs)         │
│      Asset deduplication via HashSet tracking                │
│      Checks for <style id="dm-youtube"> before inclusion     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  Final HTML Output                           │
│    <div class="dm-youtube-container">...</div>               │
│    <style id="dm-youtube">/* inline CSS */</style>           │
│    <script id="dm-youtube">/* inline JS */</script>          │
└─────────────────────────────────────────────────────────────┘
```

### Data Flow

1. **Input**: Markdown with `::youtube` directive
2. **Parse**: pulldown-cmark emits custom event for `::youtube` block
3. **Extract**: Parse video reference and optional width parameter
4. **Validate**: Check video ID format (11-char alphanumeric + `-_`)
5. **Render**: Generate HTML with iframe, maximize button, backdrop
6. **Optimize**: Deduplicate CSS/JS if multiple embeds exist
7. **Output**: Self-contained HTML ready for browser rendering

## Phases

### Phase 1: Core Parser Infrastructure

**Principal Owner:** Rust Developer

**Goal:** Implement directive parsing to extract video IDs and width parameters from `::youtube` directives.

**Dependencies:** None

**Blast Radius:** `lib/src/parse/**/*.rs` (inline tests)

**Deliverables:**
- Update `lib/src/parse/darkmatter.rs` with YouTube directive parsing
- Create `lib/src/types/youtube.rs` for WidthSpec enum
- Update `lib/src/types/darkmatter.rs` to add `DarkMatterNode::YouTube` variant
- Video ID extraction from multiple URL formats
- Width parameter parsing (px, rem, %)
- Use existing `ParseError` variants for error handling

**Technical Details:**

Files to modify/create:
- `lib/src/parse/darkmatter.rs` (UPDATE - add YouTube directive regex and parsing)
- `lib/src/types/youtube.rs` (CREATE - WidthSpec enum)
- `lib/src/types/darkmatter.rs` (UPDATE - add YouTube variant)
- `lib/src/types/mod.rs` (UPDATE - export WidthSpec)

Add to `lib/src/parse/darkmatter.rs`:
```rust
static YOUTUBE_DIRECTIVE: LazyLock<Regex> = LazyLock::new(|| {
    Regex::new(r"^::youtube\s+([^\s]+)(?:\s+(\d+(?:px|rem|%)))?$").unwrap()
});

// In parse_directive() function:
if let Some(caps) = YOUTUBE_DIRECTIVE.captures(trimmed) {
    let video_ref = caps.get(1).unwrap().as_str();
    let video_id = extract_youtube_id(video_ref)?;
    let width = caps.get(2)
        .map(|w| parse_width_spec(w.as_str()))
        .transpose()?
        .unwrap_or(WidthSpec::Pixels(512));

    return Ok(Some(DarkMatterNode::YouTube { video_id, width }));
}

fn extract_youtube_id(reference: &str) -> Result<String, ParseError> {
    // URL pattern regexes (LazyLock)
    // Return ParseError::InvalidResource on failure
}

fn parse_width_spec(width_str: &str) -> Result<WidthSpec, ParseError> {
    // Parse px, rem, % formats
    // Validate percentage 0-100
    // Return ParseError::InvalidDirective on failure
}
```

Create `lib/src/types/youtube.rs`:
```rust
#[derive(Debug, Clone, PartialEq)]
pub enum WidthSpec {
    Pixels(u32),
    Rems(f32),
    Percentage(u8), // Validated 0-100 range
}

impl Display for WidthSpec {
    fn fmt(&self, f: &mut Formatter) -> fmt::Result {
        match self {
            WidthSpec::Pixels(px) => write!(f, "{}px", px),
            WidthSpec::Rems(rem) => write!(f, "{}rem", rem),
            WidthSpec::Percentage(pct) => write!(f, "{}%", pct),
        }
    }
}
```

Update `lib/src/types/darkmatter.rs`:
```rust
pub enum DarkMatterNode {
    // ... existing variants
    YouTube {
        video_id: String,
        width: WidthSpec,
    },
}
```

Supported URL patterns (LazyLock regexes):
- `https?://(?:www\.)?youtube\.com/watch\?v=([A-Za-z0-9_-]{11})`
- `https?://youtu\.be/([A-Za-z0-9_-]{11})`
- `https?://(?:www\.)?youtube\.com/embed/([A-Za-z0-9_-]{11})`
- `https?://(?:www\.)?youtube\.com/v/([A-Za-z0-9_-]{11})`
- Raw ID: `^[A-Za-z0-9_-]{11}$`

Error handling:
- Use `ParseError::InvalidDirective` for malformed directives
- Use `ParseError::InvalidResource` for bad video IDs/URLs

**Acceptance Criteria:**
- [ ] Parse valid YouTube URLs and extract video IDs
- [ ] Parse raw video IDs (11 characters)
- [ ] Parse width specifications (512px, 32rem, 80%)
- [ ] Default width to 512px when not specified
- [ ] Return informative errors for invalid formats (using ParseError)
- [ ] Handle malformed URLs gracefully
- [ ] Validate video ID format (length, character set)
- [ ] Unit tests in `#[cfg(test)] mod tests` block in darkmatter.rs
- [ ] Tests verify LazyLock regex compilation
- [ ] Reject percentages > 100%
- [ ] Reject negative width values
- [ ] Handle URLs with query params (`?v=ID&feature=share`)
- [ ] Handle URLs with fragments

---

### Phase 2: HTML Renderer Implementation

**Principal Owner:** Rust Developer

**Goal:** Generate self-contained HTML output with inline CSS/JS for YouTube embeds.

**Dependencies:** Phase 1 (parser must provide YouTubeDirective)

**Blast Radius:** `lib/src/render/**/*.rs` (inline tests)

**Deliverables:**
- `lib/src/render/youtube.rs` - HTML generation functions
- Inline CSS for default and modal states (using LazyLock)
- Inline JavaScript for maximize/minimize interactions (using LazyLock)
- YouTube IFrame API integration

**Technical Details:**

Files to create:
- `lib/src/render/youtube.rs` (NEW)
- `lib/src/render/mod.rs` (UPDATE - export youtube module)

Key functions in `lib/src/render/youtube.rs`:
```rust
/// Renders YouTube embed HTML for a given video ID and width.
/// Does NOT include CSS/JS assets - those are managed by orchestration layer.
pub fn render_youtube_embed(video_id: &str, width: &WidthSpec) -> String {
    generate_container_html(video_id, width)
}

fn generate_container_html(video_id: &str, width: &WidthSpec) -> String {
    // Generate iframe + button + backdrop HTML
}

/// Returns the CSS required for YouTube embeds (called by orchestration layer)
pub fn youtube_css() -> &'static str {
    &YOUTUBE_CSS
}

/// Returns the JavaScript required for YouTube embeds (called by orchestration layer)
pub fn youtube_js() -> &'static str {
    &YOUTUBE_JS
}

static YOUTUBE_CSS: LazyLock<String> = LazyLock::new(|| {
    // Inline CSS as const string
});

static YOUTUBE_JS: LazyLock<String> = LazyLock::new(|| {
    // Inline JS as const string
});

fn width_to_css(width: &WidthSpec) -> String {
    width.to_string() // Uses Display impl from types/youtube.rs
}
```

HTML structure:
```html
<div class="dm-youtube-container" data-video-id="{ID}" data-width="{WIDTH}">
  <div class="dm-youtube-wrapper">
    <iframe
      class="dm-youtube-player"
      src="https://www.youtube.com/embed/{ID}?enablejsapi=1"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
      aria-label="YouTube video player">
    </iframe>
    <button class="dm-youtube-maximize" aria-label="Maximize video">
      <svg><!-- maximize icon --></svg>
    </button>
  </div>
</div>
<div class="dm-youtube-backdrop" style="display: none;"></div>
```

CSS implementation (const string):
- Default state: container width, 16:9 aspect ratio via padding-bottom
- Modal state: fixed position, 95vw width, centered, z-index layering
- Transitions: transform 300ms ease-in-out, will-change: transform
- Backdrop: full viewport, backdrop-filter: blur(8px), semi-transparent overlay

JavaScript implementation (const string):
- Load YouTube IFrame API
- Track player instances in Map
- Maximize button click handler (store position, add modal class, show backdrop)
- Minimize triggers (Escape, backdrop click, button toggle)
- Play state preservation via YouTube IFrame API

**Acceptance Criteria:**
- [ ] Generate valid HTML5 markup
- [ ] CSS and JS use LazyLock for one-time initialization
- [ ] Maintain 16:9 aspect ratio in both states
- [ ] Support custom width specifications
- [ ] Include ARIA labels for accessibility
- [ ] Maximize button positioned correctly (top-right)
- [ ] Modal centers in viewport at 95vw width
- [ ] Unit tests in `#[cfg(test)] mod tests` block in youtube.rs
- [ ] Snapshot tests verify complete HTML structure (using insta crate)

---

### Phase 3: Asset Deduplication Integration

**Principal Owner:** Rust Developer

**Goal:** Integrate YouTube asset deduplication into existing orchestration layer.

**Dependencies:** Phase 2 (renderer must be functional)

**Blast Radius:** `lib/src/render/**/*.rs` (inline tests)

**Deliverables:**
- Update orchestration layer (`lib/src/render/html.rs`) to track YouTube assets
- CSS/JS inclusion based on `<style id="dm-youtube">` check
- Document-scoped deduplication

**Technical Details:**

Files to modify:
- `lib/src/render/html.rs` (UPDATE - orchestration layer)
- Add logic to detect if YouTube assets already included

Strategy (in orchestration layer):
```rust
// In lib/src/render/html.rs (orchestration)
let mut output = String::new();
let mut youtube_assets_included = false;

for node in darkmatter_nodes {
    match node {
        DarkMatterNode::YouTube { video_id, width } => {
            // Render the embed HTML
            let embed_html = youtube::render_youtube_embed(video_id, width);
            output.push_str(&embed_html);

            // Include assets on first occurrence
            if !youtube_assets_included {
                output.push_str(&format!(
                    "\n<style id=\"dm-youtube\">{}</style>",
                    youtube::youtube_css()
                ));
                output.push_str(&format!(
                    "\n<script id=\"dm-youtube\">{}</script>",
                    youtube::youtube_js()
                ));
                youtube_assets_included = true;
            }
        }
        // ... other node types
    }
}
```

Alternative: Check if `<style id="dm-youtube">` already exists in output buffer before appending.

**Acceptance Criteria:**
- [ ] CSS/JS included only once per document
- [ ] Multiple embeds in same document render correctly
- [ ] Assets use id attributes for identification
- [ ] No visual differences between first and subsequent embeds
- [ ] JavaScript handles multiple player instances
- [ ] Unit tests verify asset tracking logic
- [ ] Integration tests with multiple embeds

---

### Phase 4: Error Handling and Edge Cases

**Principal Owner:** Rust Developer

**Goal:** Robust error handling for invalid inputs and edge cases.

**Dependencies:** Phases 1, 2, 3 (all core functionality complete)

**Blast Radius:** `lib/src/**/*.rs` (all tests)

**Deliverables:**
- User-friendly error messages using existing ParseError variants
- Graceful degradation strategies
- Documentation of error scenarios

**Technical Details:**

Files to modify:
- `lib/src/parse/darkmatter.rs` - Improve error messages in extract_youtube_id and parse_width_spec

Use existing ParseError variants (DO NOT create new YouTubeDirectiveError type):
```rust
// In lib/src/parse/darkmatter.rs

fn extract_youtube_id(reference: &str) -> Result<String, ParseError> {
    // ... extraction logic ...

    Err(ParseError::InvalidResource(format!(
        "Could not extract video ID from '{}'. \
         Supported formats: youtube.com/watch?v=ID, youtu.be/ID, or 11-character ID",
        reference
    )))
}

fn parse_width_spec(width_str: &str) -> Result<WidthSpec, ParseError> {
    // ... parsing logic ...

    Err(ParseError::InvalidDirective(format!(
        "Invalid width format '{}'. \
         Width must be pixels (512px), rems (32rem), or percentage (0-100%)",
        width_str
    )))
}
```

Error scenarios:

| Error Condition | ParseError Variant | Message |
|----------------|-------------------|---------|
| Empty/missing video reference | InvalidDirective | "YouTube directive requires video reference" |
| Invalid video ID format | InvalidResource | "Could not extract video ID from '...'" |
| Invalid width format | InvalidDirective | "Invalid width format '...'. Width must be..." |
| Malformed URL | InvalidResource | "Could not extract video ID from URL: ..." |
| Percentage > 100 | InvalidDirective | "Invalid percentage '...'. Must be 0-100%" |
| Negative width | InvalidDirective | "Width must be positive" |

**Acceptance Criteria:**
- [ ] All error conditions use appropriate ParseError variants
- [ ] Error messages are user-friendly and actionable
- [ ] Errors include suggestions for fixing the issue
- [ ] Invalid inputs don't cause panics
- [ ] Errors propagate correctly through the rendering pipeline
- [ ] String assertion tests verify exact error message content
- [ ] Error messages include context (the invalid input value)

---

### Phase 5: Testing and Documentation

**Principal Owner:** Feature Tester (Rust)

**Goal:** Comprehensive test coverage and documentation for YouTube embedding feature.

**Dependencies:** Phase 4 (all functionality and error handling complete)

**Blast Radius:** `lib/src/**/*.rs` and `tests/**/*.rs` (all tests)

**Deliverables:**
- Unit tests (inline `#[cfg(test)]` modules)
- Integration tests for end-to-end workflow
- Snapshot tests for HTML output verification
- Property-based tests for URL parsing and video ID validation
- Benchmark tests for performance verification
- Documentation updates
- Example markdown files

**Technical Details:**

Test files to create/modify:
- `lib/src/parse/darkmatter.rs` - Add `#[cfg(test)] mod tests` with YouTube directive tests
- `lib/src/render/youtube.rs` - Add `#[cfg(test)] mod tests` with rendering tests
- `tests/youtube_integration.rs` (NEW - integration tests)
- `benches/youtube_parsing.rs` (NEW - criterion benchmarks)
- Add `insta` to dev-dependencies for snapshot testing
- Add `rstest` to dev-dependencies for parameterized tests (optional)

Test scenarios:

**Parser tests** (in `lib/src/parse/darkmatter.rs #[cfg(test)] mod tests`):
- Parse `youtube.com/watch?v=ID` format
- Parse `youtu.be/ID` format
- Parse `youtube.com/embed/ID` format
- Parse raw 11-character video IDs
- Parse width specifications (512px, 32rem, 80%)
- Default width to 512px when not specified
- Error handling for invalid video ID formats
- Error handling for invalid width formats
- Reject percentages > 100%
- Reject negative width values
- Handle URLs with query params (`?v=ID&feature=share`)
- Handle URLs with fragments
- Verify LazyLock regex compiled only once

**Renderer tests** (in `lib/src/render/youtube.rs #[cfg(test)] mod tests`):
- Generate correct HTML structure
- Include ARIA labels in all interactive elements
- Width specifications render correctly to CSS
- LazyLock CSS/JS initialized only once
- Snapshot tests for HTML output (using insta)
- Snapshot test: default width (512px)
- Snapshot test: custom pixel width
- Snapshot test: rem width
- Snapshot test: percentage width
- WidthSpec Display trait formatting

**Integration tests** (in `tests/youtube_integration.rs`):
- Full markdown to HTML conversion
- Multiple YouTube embeds in same document
- YouTube embeds with other DarkMatter directives (tables, popovers, etc.)
- Error propagation end-to-end
- Asset deduplication across multiple embeds
- Verify `<style id="dm-youtube">` included only once
- Verify `<script id="dm-youtube">` included only once

**Property-based tests** (using proptest):
- Valid video IDs (11-char strings with [A-Za-z0-9_-])
- URL parsing consistency (different formats → same video ID)
- Width value ranges (positive u32 for px, positive f32 for rem, 0-100 for %)
- HTML injection attempts via video ID fail validation

**Benchmark tests** (in `benches/youtube_parsing.rs` using criterion):
- Video ID extraction performance (1000 URLs)
- HTML generation performance (100 embeds)
- Regex compilation overhead verification

Documentation updates:
- Update `docs/features/darkmatter-dsl.md` with YouTube embedding section and examples
- Add module-level doc comment in `lib/src/render/youtube.rs` with usage example
- Add doc tests for public functions (`extract_youtube_id`, `render_youtube_embed`)
- Create example file `examples/youtube-embedding.md` demonstrating all formats

**Acceptance Criteria:**
- [ ] Unit test coverage > 90%
- [ ] All error paths tested with string assertions
- [ ] Integration tests pass
- [ ] Property-based tests for video ID validation and URL parsing
- [ ] Snapshot tests verify HTML structure
- [ ] Benchmark tests confirm regex compiled once
- [ ] Documentation includes usage examples
- [ ] Examples demonstrate all width formats (px, rem, %)
- [ ] Examples show error handling scenarios
- [ ] Doc tests in public API functions

---

## Cross-Cutting Concerns

### Testing Strategy

- **Unit tests**: Each phase includes unit tests in `#[cfg(test)] mod tests` blocks
- **Integration tests**: End-to-end tests in `tests/integration/` directory
- **Property-based tests**: Use proptest for video ID validation and width parsing
- **Manual testing**: Browser testing of generated HTML across devices

### Security Considerations

- **XSS Prevention**: Video IDs validated via strict regex (alphanumeric + `-_` only)
- **URL Validation**: Only extract IDs from youtube.com/youtu.be domains
- **No eval()**: All JavaScript static, no dynamic code execution
- **CSP Compatibility**: Inline scripts may require CSP adjustments (document in README)
- **HTTPS Only**: Force https:// for all YouTube embed URLs

### Performance Considerations

- **Asset Deduplication**: CSS/JS included once per document via orchestration layer tracking
- **Regex Optimization**: Use `std::sync::LazyLock` for one-time regex compilation (consistent with codebase)
- **String Allocation**: Minimize allocations in hot paths, reuse buffers where possible
- **Concurrent Rendering**: Ensure rendering is thread-safe for rayon parallelization (LazyLock is thread-safe)
- **Benchmarking**: Use criterion to verify performance targets (1000 URL parses < 10ms)

### Accessibility Considerations

- **ARIA Labels**: All interactive elements have aria-label attributes
- **Keyboard Navigation**: Maximize button keyboard accessible
- **Focus Management**: Modal traps focus, Escape returns focus
- **Screen Readers**: Semantic HTML, proper button roles
- **Color Contrast**: Ensure sufficient contrast for button icons

---

## Parallelization Opportunities

Due to the sequential nature of this feature (each phase builds on the previous), parallelization is limited. However, within Phase 5, tests can be parallelized:

| Parallel Group | Phases | Reason |
|----------------|--------|--------|
| Sequential | 1 → 2 → 3 → 4 | Each phase depends on previous |
| Parallel (Phase 5) | Parser tests, Renderer tests, Integration tests, Documentation | Independent test suites |

### Parallelization Diagram

```text
Timeline:
─────────────────────────────────────────────────────►

Phase 1: ████████ (Parser)
              │
Phase 2:      └──████████ (Renderer)
                      │
Phase 3:              └──████████ (Deduplication)
                              │
Phase 4:                      └──████████ (Error Handling)
                                      │
Phase 5:                              └──████████████████
                                          (Tests in parallel)
                                          ├─ Parser tests
                                          ├─ Renderer tests
                                          ├─ Integration tests
                                          └─ Documentation
```

### Synchronization Points

1. **After Phase 1:** YouTubeDirective struct API frozen
2. **After Phase 2:** HTML structure finalized
3. **After Phase 4:** All error types defined
4. **Final:** All tests pass, documentation complete

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| YouTube API changes (iframe embed URL) | High | Use official YouTube embed URL format; monitor API deprecations |
| CSP compatibility issues with inline scripts | Medium | Document CSP requirements; provide nonce attribute option in future |
| Video ID regex too strict/lenient | Medium | Use official YouTube ID format (11 chars, base64-like); test edge cases |
| Modal z-index conflicts with existing page styles | Low | Use high z-index (9999); document override mechanism |
| Browser compatibility for backdrop-filter | Low | Provide fallback styles for older browsers |
| Rendering performance with many embeds | Low | Asset deduplication mitigates; benchmark with 50+ embeds |

---

## Open Questions - RESOLVED

All open questions have been answered based on review feedback:

- [x] **Playlists**: No - defer to v2, adds complexity
- [x] **Video validation**: Trust user input - no oEmbed API calls (keep it simple, avoid network dependencies)
- [x] **Timestamp parameters**: Yes - easy to add `?t=30s` to iframe URL
- [x] **Configurable modal**: No - always enabled, keep it simple
- [x] **Other platforms**: No - YouTube only for v1
- [x] **z-index value**: 9999 - standard high value, document override mechanism
- [x] **Theme option**: No - use single neutral design

---

## Next Steps

1. **User approval** of this plan
2. **Answer open questions** to finalize requirements
3. **Execute phases sequentially** using `/execute-phase <n>`
4. **Update plan** if implementation reveals new information
